<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦æ–‡æ¡ˆç”Ÿæˆå™¨ - v6.3 ç¤¾ä¼šåŒ–ä¸“ç”¨ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* UI ä¿æŒé«˜ç«¯ç‰ˆ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .admin-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.5); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; transition: all 0.3s; }
        .admin-btn:hover { background: rgba(255,255,255,0.3); }
        .content { padding: 30px; }
        .section { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; display: flex; align-items: center; }
        .info-box { background: white; border-left: 4px solid #ff9800; padding: 15px; margin-bottom: 15px; border-radius: 4px; font-size: 13px; color: #666; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px; }
        input[type="text"], input[type="password"], input[type="date"], input[type="file"], select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #667eea; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-right: 10px; margin-bottom: 10px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 14px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .hidden { display: none !important; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .code-display { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; }
        .progress-container { margin-top: 20px; }
        .progress-bar { width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold; }
        .log { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.8; }
        .log-item { margin-bottom: 5px; padding: 5px; border-left: 3px solid #667eea; padding-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="admin-btn" onclick="window.location.reload()" style="left: 20px; right: auto;">ğŸ”„ åˆ·æ–°</button>
            <h1>ğŸ¨ å°çº¢ä¹¦æ–‡æ¡ˆç”Ÿæˆå™¨</h1>
            <p>v6.3 ç¤¾ä¼šåŒ–ä¸“ç”¨ç‰ˆ - æ‰¾å›çŠ¶æ€æ˜¾ç¤º | æš‚åœè‡ªåŠ¨å¯¼å‡º</p>
            <button class="admin-btn" onclick="showAdminModal()">âš™ï¸ ç®¡ç†</button>
        </div>
        
        <div class="content">
            <div class="section" id="activationSection">
                <div class="section-title">ğŸ”‘ è½¯ä»¶æ¿€æ´»</div>
                <div class="form-group">
                    <label>è¯·è¾“å…¥æ¿€æ´»ç </label>
                    <input type="text" id="activationCode" placeholder="XHS-ALL-xxxx-xxxx">
                </div>
                <button class="btn btn-primary" onclick="activate()">æ¿€æ´»è½¯ä»¶</button>
                <div class="status hidden" id="activationStatus"></div>
            </div>
            
            <div class="section hidden" id="activatedInfo">
                <div class="section-title">âœ… å·²æ¿€æ´»</div>
                <p>ä¸šåŠ¡çº¿: <span id="businessInfo"></span></p>
                <p>åˆ°æœŸæ—¶é—´: <span id="expireInfo"></span></p>
                <button class="btn btn-secondary" onclick="resetActivation()">é€€å‡ºç™»å½•</button>
            </div>

            <div class="section hidden" id="apiConfigSection">
                <div class="section-title">ğŸ”Œ API é…ç½® (Claude 3.5)</div>
                <div class="info-box">
                    <p>âš ï¸ éœ€ç”¨æˆ·è‡ªå¤‡ Keyã€‚æœ¬ç‰ˆæœ¬ä¸“é—¨é’ˆå¯¹â€œç¤¾ä¼šåŒ–æŒ‡å—â€ä¼˜åŒ–ï¼Œä¸¥ç¦ç”Ÿæˆä½å¹¼å†…å®¹ã€‚</p>
                </div>
                <div class="form-group">
                    <label>API Key (ä»¥ sk- å¼€å¤´)</label>
                    <input type="password" id="userApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
                </div>
                <button class="btn btn-primary" onclick="saveUserApiKey()">ğŸ’¾ ä¿å­˜ Key</button>
                <div class="status hidden" id="apiStatus"></div>
            </div>
            
            <div class="section hidden" id="assignSection">
                <div class="section-title">ğŸ” æ­¥éª¤1ï¼šæ™ºèƒ½åˆ†é…é€‰é¢˜</div>
                <div class="info-box">ä¸‹è½½ç©ºç™½æ¨¡æ¿ -> å¡«å…¥æ ‡é¢˜ -> ä¸Šä¼ åˆ†é… -> å¾—åˆ°ç”¨äºç”Ÿæˆçš„Excel</div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="downloadBlankTemplate()">ğŸ“¥ ä¸‹è½½ç©ºç™½æ¨¡æ¿</button>
                    <button class="btn btn-success" onclick="document.getElementById('assignFile').click()">ğŸ“¤ ä¸Šä¼ å¹¶åˆ†é…</button>
                </div>
                <input type="file" id="assignFile" accept=".xlsx,.xls" style="display:none" onchange="handleAssignFile()">
                <div class="status hidden" id="assignFileInfo"></div>
            </div>
            
            <div class="section hidden" id="generateSection">
                <div class="section-title">ğŸ“ æ­¥éª¤2ï¼šAI æ‰¹é‡ç”Ÿæˆ</div>
                
                <div class="form-group" style="background: #e7f3ff; padding: 15px; border-radius: 8px; border: 1px solid #b3d9ff;">
                    <label style="color: #0066cc;">ğŸ¯ ç¯‡å¹…é€‰æ‹©</label>
                    <select id="contentLength">
                        <option value="standard">ğŸ”µ æ ‡å‡†ç‰ˆ (500-600å­— | å®Œè¯»ç‡é«˜)</option>
                        <option value="long">ğŸŸ£ æ·±åº¦ç‰ˆ (850-950å­— | æ”¶è—ç‡é«˜)</option>
                    </select>
                    <div class="info-box" style="margin-top: 10px; background: #fff3cd; border-left-color: #ffc107; color: #856404;">
                        âš ï¸ <b>å¼ºåˆ¶æˆäººæ¨¡å¼ï¼š</b> ç³»ç»Ÿä¼šå¼ºåˆ¶å°†â€œå®å®â€ç†è§£ä¸ºæˆå¹´è¯»è€…ï¼Œæ ‡é¢˜å«â€œæ•™å­©å­â€ä¼šç†è§£ä¸ºâ€œé‡å…»è‡ªå·±ä¸€éâ€ã€‚
                    </div>
                </div>

                <div class="form-group">
                    <label>ä¸Šä¼ ã€æ­¥éª¤1ã€‘ç”Ÿæˆçš„åˆ†é…ç»“æœ</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileSelect()">
                    <div class="status hidden" id="fileInfo"></div>
                </div>
                
                <button class="btn btn-primary" id="generateBtn" onclick="startGeneration()" disabled>ğŸš€ å¼€å§‹ç”Ÿæˆ (æ¶ˆè€—Key)</button>
                <button class="btn" style="background: #ff9800; color: white; display: none;" onclick="pauseGeneration()" id="pauseBtn">â¸ï¸ æš‚åœ</button>
                
                <div class="progress-container hidden" id="progressContainer">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div>
                    <div class="log" id="log"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ”§ ç®¡ç†å‘˜é¢æ¿</h3>
                <button class="close-btn" onclick="closeAdminModal()">Ã—</button>
            </div>
            <div id="adminLogin">
                <div class="form-group">
                    <input type="password" id="adminPassword" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                </div>
                <button class="btn btn-primary" onclick="adminLogin()">ç™»å½•</button>
            </div>
            <div id="adminPanel" class="hidden">
                <div class="form-group">
                    <label>ä¸šåŠ¡çº¿</label>
                    <select id="businessType"><option value="all">å…¨åŠŸèƒ½ç‰ˆ</option></select>
                </div>
                <div class="form-group">
                    <label>åˆ°æœŸæ—¥æœŸ</label>
                    <input type="date" id="expireDate">
                </div>
                <button class="btn btn-success" onclick="generateCode()">ç”Ÿæˆæ¿€æ´»ç </button>
                <div class="code-display hidden" id="codeDisplay">
                    <div class="code-text" id="generatedCode"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½® ==========
        const CONFIG = {
            SECRET_KEY: "xiaohongshu_2025_secret_key_change_me",
            ADMIN_PASSWORD: "admin", 
            API_BASE_URL: "https://api.gptsapi.net/v1/chat/completions",
            MODEL: "claude-3-5-sonnet-20240620", 
            
            // æ•æ„Ÿè¯
            SENSITIVE_WORDS: {
                'å¾®ä¿¡': 'å¹³æ—¶èŠå¤©', 'åŠ å¾®ä¿¡': 'åŠ å¥½å‹', 'é’±': 'ç±³', 'èµšé’±': 'æç±³',
                'ç§ä¿¡': 'åå°', 'æŠ€å·§': 'æ–¹æ³•', 'å¸®åŠ©': 'ååŠ©', 'æ²¦ä¸º': 'å˜æˆ',
                'èŒåœº': 'å€¼åœº', 'å…¬å¸': 'å…¬åŒ', 'å•ä½': 'å–®ä½', 'åŒäº‹': 'åŒå£«', 'å¼•æµ': 'å¯¼æµ', 'è¥é”€': 'è¥æ¶ˆ'
            },
            
            // çœŸå®çƒ­æœè¯åº“
            KEYWORDS: {
                'work': ['èŒåœº', 'èŒåœºç”Ÿå­˜æ³•åˆ™', 'èŒåœºå¹²è´§', 'èŒåœºæ€ç»´', 'èŒåœºäººé™…å…³ç³»'],
                'social': ['ç¤¾ä¼šåŒ–', 'äººæƒ…ä¸–æ•…', 'é«˜æƒ…å•†', 'ä¸ºäººå¤„äº‹', 'ç¤¾äº¤æŠ€å·§'],
                'growth': ['ä¸ªäººæˆé•¿', 'æˆé•¿', 'è‡ªæˆ‘æå‡', 'æ€ç»´æå‡', 'è®¤çŸ¥è§‰é†’']
            },

            // å®Œç¾ç»“å°¾é’©å­
            ENDING: `\n\nğŸ’¡ è¿™ä»½ã€Šæ™®é€šäººç¤¾ä¼šåŒ–æŒ‡å—ã€‹èƒ½å¸®ä½ ä»€ä¹ˆï¼Ÿ\n\n1ï¸âƒ£ å…¨å¥—å¹²è´§ï¼š20ä¸‡å­— + 67èŠ‚ç³»ç»Ÿè¯¾ï¼Œä¸è®²ç©ºè¯ï¼Œåªæ•™æ–¹æ³•ã€‚\n2ï¸âƒ£ å…¨æ™¯è¦†ç›–ï¼šä»é¥­å±€åº”é…¬åˆ°å€¼åœºæ™‹å‡ï¼Œä»æ‹’ç»å†…è€—åˆ°å‘ä¸Šç¤¾äº¤ã€‚\n3ï¸âƒ£ å®æˆ˜å·¥å…·ï¼šé™„èµ è¶…å…¨æ€ç»´å¯¼å›¾ï¼ˆç”µå­ç‰ˆï¼‰ï¼Œæ‹¿æ¥å°±èƒ½ç”¨ã€‚\n\nğŸ‘¥ è¿™å¥—æŒ‡å—é€‚åˆè°ï¼Ÿ\n\nâœ… ç¤¾æ/å†…å‘è€…ï¼šå®³æ€•ç¤¾äº¤ï¼Œæƒ³æ‘†è„±ç´§å¼ å°´å°¬\nâœ… å€¼åœºè€å®äººï¼šä¸æ‡‚æ‹’ç»ï¼Œæ€»è¢«æ‹¿æï¼Œæƒ³å»ºç«‹è¾¹ç•Œ\nâœ… æ²Ÿé€šå°ç™½ï¼šè¯´è¯ç›´æ¥ç›´å»ï¼Œå¸¸å¾—ç½ªäººï¼Œæƒ³æé«˜æƒ…å•†\n\nâ—ï¸â—ï¸ éœ€è¦çš„å®å­ï¼Œç›´æ¥å»æˆ‘ä¸»é¡µåº—é“ºå¸¦èµ° ğŸ›’ğŸ›’ğŸ›’`
        };

        // ========== API Key ç®¡ç† ==========
        function saveUserApiKey() {
            const key = document.getElementById('userApiKey').value.trim();
            if (!key.startsWith('sk-')) return showStatus('apiStatus', 'âŒ Key æ ¼å¼é”™è¯¯', 'error');
            localStorage.setItem('user_api_key', key);
            showStatus('apiStatus', 'âœ… Key å·²ä¿å­˜', 'success');
            setTimeout(() => { 
                document.getElementById('assignSection').classList.remove('hidden');
                document.getElementById('generateSection').classList.remove('hidden'); 
            }, 500);
        }

        // ========== è¾…åŠ©å‡½æ•° ==========
        function randomPickMultiple(array, count) { return array.sort(() => 0.5 - Math.random()).slice(0, count); }

        // ========== æ­¥éª¤1ï¼šåˆ†é…é€»è¾‘ (æ‰¾å›çš„åŠŸèƒ½) ==========
        function downloadBlankTemplate() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['æ ‡é¢˜']]), "ç©ºç™½æ¨¡æ¿");
            XLSX.writeFile(wb, 'æ­¥éª¤1_ç©ºç™½æ¨¡æ¿.xlsx');
        }

        function handleAssignFile() {
            const f = document.getElementById('assignFile').files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                // è‡ªåŠ¨åˆ†é…é€»è¾‘
                const results = data.map((r, i) => ({
                    'åºå·': i+1, 
                    'æ ‡é¢˜': r['æ ‡é¢˜'], 
                    'é€‰é¢˜': 'æ™ºèƒ½è¯†åˆ«', // è¿™é‡Œå…¶å®APIä¸å¤ªéœ€è¦é€‰é¢˜åˆ—ï¼Œä½†ä¸ºäº†æ ¼å¼ç»Ÿä¸€ä¿ç•™
                    'ç”Ÿæˆæ•°é‡': 1 
                }));
                
                const newWb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWb, XLSX.utils.json_to_sheet(results), "åˆ†é…ç»“æœ");
                XLSX.writeFile(newWb, `åˆ†é…ç»“æœ_${Date.now()}.xlsx`);
                showStatus('assignFileInfo', 'âœ… åˆ†é…å®Œæˆï¼Œæ–‡ä»¶å·²ä¸‹è½½', 'success');
            };
            reader.readAsArrayBuffer(f);
        }

        // ========== æ ¸å¿ƒç”Ÿæˆé€»è¾‘ (å¼ºåˆ¶æˆäººç‰ˆ) ==========
        async function generateSocial(row) {
            const mode = document.getElementById('contentLength').value;
            
            // âš ï¸ å¼ºåˆ¶æˆäººçš„ Prompt
            const ADULT_CONSTRAINT = `
ã€é‡è¦è®¾å®šã€‘
1. **ç›®æ ‡è¯»è€…**ï¼š20-30å²çš„èŒåœºæ–°äººã€å¤§å­¦ç”Ÿã€æˆ–æœ‰ç¤¾äº¤å›°æ‰°çš„æˆå¹´äººã€‚
2. **å…³é”®è¯é‡å®šä¹‰**ï¼šæ ‡é¢˜å¦‚æœå‡ºç°"å®å®"ï¼ŒæŒ‡çš„æ˜¯"äº²çˆ±çš„è¯»è€…(æˆå¹´äºº)"ï¼Œç»å¯¹ä¸æ˜¯å©´å„¿ï¼æ ‡é¢˜å¦‚æœå‡ºç°"å­©å­"ï¼ŒæŒ‡çš„æ˜¯"åƒå­©å­ä¸€æ ·è¿·èŒ«çš„æˆå¹´äºº"æˆ–"å†…å¿ƒçš„å°å­©"ã€‚
3. **ä¸¥ç¦åœºæ™¯**ï¼šç»å¯¹ä¸è¦å†™å¹¼å„¿å›­ã€å¸¦å¨ƒã€è€å¸ˆè¡¨æ‰¬ã€æ”¾å­¦å›å®¶ç­‰ä½å¹¼åœºæ™¯ï¼è¯·å†™èŒåœºã€èšä¼šã€é¥­å±€ã€‚
4. **è¯­æ°”é£æ ¼**ï¼šæˆç†Ÿã€çŸ¥æ€§ã€æ¸…é†’ã€æœ‰æ·±åº¦çš„èŒåœº/ç¤¾äº¤å¯¼å¸ˆã€‚`;

            const promptStandard = `ä½ æ˜¯ä¸€ä½èŒåœºç¤¾äº¤å¯¼å¸ˆã€‚è¯·ä¸ºæ ‡é¢˜ã€Š${row['æ ‡é¢˜']}ã€‹å†™ä¸€ç¯‡**æç®€**å¹²è´§æ­£æ–‡ï¼ˆä¸è¦ç»“å°¾ï¼‰ã€‚
${ADULT_CONSTRAINT}
ã€ç»å¯¹çº¢çº¿ã€‘æ­£æ–‡å¿…é¡»æ§åˆ¶åœ¨ **280-320å­—** ä¹‹é—´ï¼
ã€ç»“æ„ã€‘1.å¼€å¤´20å­—ç—›ç‚¹(æˆäººè§†è§’)ã€‚2.ä¸­é—´3ä¸ªæ–¹æ³•[ä¸€R][äºŒR][ä¸‰R]ï¼Œæ¯ç‚¹60å­—ã€‚
ã€ç¦ä»¤ã€‘ç¦æ­¢è‹±æ–‡ã€æ•æ„Ÿè¯ã€ä¸è¦å†™ç»“å°¾ã€‚`;

            const promptLong = `ä½ æ˜¯ä¸€ä½æ·±è°™äººæ€§çš„å¿ƒç†å’¨è¯¢å¸ˆã€‚è¯·ä¸ºæ ‡é¢˜ã€Š${row['æ ‡é¢˜']}ã€‹å†™ä¸€ç¯‡æ·±åº¦æ­£æ–‡ï¼ˆä¸è¦ç»“å°¾ï¼‰ã€‚
${ADULT_CONSTRAINT}
ã€ç»å¯¹çº¢çº¿ã€‘æ­£æ–‡å¿…é¡»æ§åˆ¶åœ¨ **600-650å­—** ä¹‹é—´ï¼
ã€ç»“æ„ã€‘1.å¼€å¤´60å­—æˆäººç¤¾äº¤æ•…äº‹ã€‚2.ä¸­é—´3ä¸ªå»ºè®®[ä¸€R][äºŒR][ä¸‰R]ï¼Œæ¯ç‚¹150å­—å«å¿ƒç†åˆ†æã€‚
ã€ç¦ä»¤ã€‘ç¦æ­¢è‹±æ–‡ã€æ•æ„Ÿè¯ã€ä¸è¦å†™ç»“å°¾ã€‚`;

            const finalPrompt = (mode === 'long') ? promptLong : promptStandard;
            const maxTokens = (mode === 'long') ? 1200 : 600;

            const userKey = localStorage.getItem('user_api_key');
            const response = await fetch(CONFIG.API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userKey}` },
                body: JSON.stringify({
                    model: CONFIG.MODEL,
                    messages: [{ role: "user", content: finalPrompt }],
                    temperature: 0.85, max_tokens: maxTokens
                })
            });
            const data = await response.json();
            const content = data.choices[0].message.content;
            
            // åå¤„ç†
            let body = content.replace(/\*\*/g, "").replace(/\b[A-Za-z]{2,}\b/g, ""); // åˆ è‹±æ–‡
            body = body.replace(/\[1\]/g, "[ä¸€R]").replace(/\[2\]/g, "[äºŒR]").replace(/\[3\]/g, "[ä¸‰R]");
            body = body.replace(/([^\n])\[([ä¸€äºŒä¸‰]R)\]/g, "$1\n\n[$2]"); // å¼ºåˆ¶æ¢è¡Œ
            
            // æ¸…é™¤æ ‡é¢˜æ³„éœ²
            const lines = body.split('\n');
            if (lines.length > 0) {
                const firstLine = lines[0].trim();
                if (firstLine.includes('æ ‡é¢˜ï¼š') || firstLine.includes('å°çº¢ä¹¦æ ‡é¢˜') || firstLine === row['æ ‡é¢˜']) {
                    lines.shift();
                    if (lines.length > 0 && (lines[0].trim().includes('æ­£æ–‡ï¼š') || lines[0].trim() === 'æ­£æ–‡')) lines.shift();
                    body = lines.join('\n').trim();
                }
            }

            // æ‹¼æ¥ç»“å°¾
            let full = body + CONFIG.ENDING;
            // å…¨åŸŸæ¸…æ´—
            for (const [key, val] of Object.entries(CONFIG.SENSITIVE_WORDS)) {
                full = full.replace(new RegExp(key, 'g'), val);
            }
            
            // è¯é¢˜
            let tags = ['#æ™®é€šäººç¤¾ä¼šåŒ–æŒ‡å—', '#äººæƒ…ä¸–æ•…'];
            tags.push(...randomPickMultiple(CONFIG.KEYWORDS.work, 3).map(t=>'#'+t));
            tags.push(...randomPickMultiple(CONFIG.KEYWORDS.social, 3).map(t=>'#'+t));
            tags.push(...randomPickMultiple(CONFIG.KEYWORDS.growth, 2).map(t=>'#'+t));
            
            return { title: row['æ ‡é¢˜'], body: full, tags: tags.slice(0,10).join(' ') };
        }

        // ========== æµç¨‹æ§åˆ¶ ==========
        let excelData = null;
        let isPaused = false;
        let pauseRequested = false;

        function handleFileSelect() {
            const f = document.getElementById('excelFile').files[0];
            if(!f) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                excelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if (!excelData[0]['æ ‡é¢˜']) {
                    showStatus('fileInfo', 'âŒ é”™è¯¯ï¼šè¯·ä¸Šä¼ ã€æ­¥éª¤1ã€‘ç”Ÿæˆçš„åˆ†é…ç»“æœï¼ˆéœ€åŒ…å«æ ‡é¢˜åˆ—ï¼‰', 'error');
                } else {
                    showStatus('fileInfo', `âœ… å·²åŠ è½½ ${excelData.length} æ¡ä»»åŠ¡`, 'success');
                    document.getElementById('generateBtn').disabled = false;
                }
            };
            reader.readAsArrayBuffer(f);
        }

        async function startGeneration() {
            const userKey = localStorage.getItem('user_api_key');
            if (!userKey) { alert("è¯·å…ˆé…ç½®Key"); return; }
            
            isPaused = false;
            pauseRequested = false;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('progressContainer').classList.remove('hidden');
            const log = document.getElementById('log'); log.innerHTML = '';
            
            const results = [];
            const total = excelData.length;

            for (let i = 0; i < total; i++) {
                // æš‚åœæ£€æŸ¥ç‚¹
                if (pauseRequested) {
                    isPaused = true;
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(results), "æš‚åœä¿å­˜");
                    XLSX.writeFile(wb, `æš‚åœå¤‡ä»½_${Date.now()}.xlsx`);
                    
                    // ğŸ”´ å¢åŠ ï¼šæš‚åœåçš„æ—¥å¿—æç¤º
                    log.innerHTML += `<div class="log-item" style="background:#fff3cd; color:#856404; font-weight:bold;">â¸ï¸ ä»»åŠ¡æš‚åœï¼Œå·²è‡ªåŠ¨å¯¼å‡ºå½“å‰è¿›åº¦ Excel</div>`;
                    log.scrollTop = log.scrollHeight;
                    
                    document.getElementById('pauseBtn').innerText = "â–¶ï¸ ç»§ç»­";
                    return; 
                }

                const row = excelData[i];
                if (!row['æ ‡é¢˜']) continue;

                // ğŸ”´ ä¿®æ”¹ï¼šæ—¥å¿—æ ¼å¼ï¼Œæ˜¾ç¤º[1/61] AI æ­£åœ¨åˆ›ä½œ...
                log.innerHTML += `<div class="log-item">[${i+1}/${total}] AI æ­£åœ¨åˆ›ä½œ: ${row['æ ‡é¢˜']}...</div>`;
                log.scrollTop = log.scrollHeight;

                try {
                    let res = await generateSocial(row);
                    results.push({
                        'åºå·': i+1, 'åŸæ ‡é¢˜': row['æ ‡é¢˜'],
                        'ç”Ÿæˆæ ‡é¢˜': res.title, 'ç”Ÿæˆæ–‡æ¡ˆ': res.body, 'è¯é¢˜': res.tags, 'å­—æ•°': res.body.length
                    });
                    
                    // ğŸ”´ æ–°å¢ï¼šæˆåŠŸæç¤º âœ… æˆåŠŸ (XXXå­—)
                    log.innerHTML += `<div class="log-item" style="color: green; font-weight: bold; margin-bottom: 10px;">âœ… æˆåŠŸ (${res.body.length}å­—)</div>`;
                    
                    document.getElementById('progressFill').style.width = ((i+1)/total*100) + '%';
                } catch (e) {
                    console.error(e);
                    log.innerHTML += `<div class="log-item" style="color:red; font-weight:bold;">âŒ å¤±è´¥: ${e.message}</div>`;
                }
                
                await new Promise(r => setTimeout(r, 1000));
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(results), "ç»“æœ");
            XLSX.writeFile(wb, `ç¤¾ä¼šåŒ–æŒ‡å—æ–‡æ¡ˆ_${Date.now()}.xlsx`);
            
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('pauseBtn').style.display = 'none';
            log.innerHTML += `<div class="log-item" style="background:#d4edda; color:#155724; padding:10px;">ğŸ‰ å…¨éƒ¨å®Œæˆï¼å·²å¯¼å‡º Excel</div>`;
        }

        function pauseGeneration() { 
            if(isPaused) { 
                isPaused = false;
                pauseRequested = false;
                document.getElementById('pauseBtn').innerText = "â¸ï¸ æš‚åœ";
                startGeneration(); 
            } else {
                pauseRequested = true; 
            }
        }

        // ========== æ¿€æ´»ç å…¼å®¹é€»è¾‘ ==========
        function generateActivationCode(businessType, expireDate) {
            const dateStr = expireDate.replace(/-/g, '');
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            const check = CryptoJS.MD5(businessType.toUpperCase() + dateStr + CONFIG.SECRET_KEY).toString().substring(0, 4).toUpperCase();
            return `XHS-${businessType.toUpperCase()}-${dateStr}-${random}-${check}`;
        }

        function validateActivationCode(code) {
            try {
                const parts = code.trim().toUpperCase().split('-');
                if (parts.length !== 5 || parts[0] !== 'XHS') return { valid: false, msg: "æ ¼å¼é”™è¯¯" };
                const [_, business, dateStr, random, check] = parts;
                const expectedCheckNew = CryptoJS.MD5(business + dateStr + CONFIG.SECRET_KEY).toString().substring(0, 4).toUpperCase();
                let expectedCheckOld = "";
                if (business === 'ALL') expectedCheckOld = CryptoJS.MD5('all' + dateStr + CONFIG.SECRET_KEY).toString().substring(0, 4).toUpperCase();
                if (check !== expectedCheckNew && check !== expectedCheckOld) return { valid: false, msg: "æ ¡éªŒå¤±è´¥" };
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6)) - 1;
                const day = parseInt(dateStr.substring(6, 8));
                if (new Date() > new Date(year, month, day + 1)) return { valid: false, msg: "æ¿€æ´»ç å·²è¿‡æœŸ" };
                return { valid: true, business: business, expireDate: `${year}-${month+1}-${day}`, msg: "æ¿€æ´»æˆåŠŸ" };
            } catch (e) { return { valid: false, msg: "æ— æ•ˆæ¿€æ´»ç " }; }
        }

        // åˆå§‹åŒ–
        function showAdminModal() { document.getElementById('adminModal').classList.add('show'); }
        function closeAdminModal() { document.getElementById('adminModal').classList.remove('show'); }
        function showStatus(id, msg, type) { const el = document.getElementById(id); el.textContent = msg; el.className = `status ${type}`; el.classList.remove('hidden'); }
        function adminLogin() { if(document.getElementById('adminPassword').value === CONFIG.ADMIN_PASSWORD) { document.getElementById('adminLogin').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('hidden'); } else alert('å¯†ç é”™è¯¯'); }
        function generateCode() { const date = document.getElementById('expireDate').value; if(!date) return alert('é€‰æ—¥æœŸ'); const code = generateActivationCode('all', date); document.getElementById('generatedCode').textContent = code; document.getElementById('codeDisplay').classList.remove('hidden'); }
        
        window.onload = function() {
            const act = JSON.parse(localStorage.getItem('activation'));
            const key = localStorage.getItem('user_api_key');
            if (act) {
                document.getElementById('activationSection').classList.add('hidden');
                document.getElementById('activatedInfo').classList.remove('hidden');
                document.getElementById('apiConfigSection').classList.remove('hidden');
                document.getElementById('businessInfo').textContent = act.business;
                document.getElementById('expireInfo').textContent = act.expireDate;
                if (key) { 
                    document.getElementById('userApiKey').value = key; 
                    document.getElementById('assignSection').classList.remove('hidden');
                    document.getElementById('generateSection').classList.remove('hidden'); 
                }
            }
        };
    </script>
</body>
</html>
